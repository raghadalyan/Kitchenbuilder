@page "/countertop-options"
@using System.IO
@using System.Text.Json
@inject NavigationManager NavManager
@inject SolidWorksSessionService SwSession
@using Kitchenbuilder.Core
@using static Kitchenbuilder.Core.HandleCounterTop
@using SolidWorks.Interop.sldworks
@using SolidWorks.Interop.swconst

<h1 class="title">Adjust Countertop Distances</h1>

@if (isLoading)
{
    <div class="loading-container">
        <img src="Images/Loading.gif" alt="Loading..." />
        <p>Loading countertops... please wait</p>
    </div>
}
else
{
    <p class="status-message">
        ✅ Reached Countertop Options Page for: <span style="color:#2c3e50">@baseName</span>
    </p>


    @if (stations.Count > 0)
    {
        <div class="step-indicators">
            @for (int i = 0; i < stations.Count; i++)
            {
                <div @onclick="@(() => GoTo(i))"
                     class="@(i == currentStationIndex ? "step-indicator active" : "step-indicator")">
                    @(i + 1)
                </div>

            }
        </div>

        <div class="station-box">
            <img src="Images/Delete.png" class="delete-icon" @onclick="DeleteCountertop" alt="Delete" title="Delete countertop" />

            <h3>📐 Editing: CT_@CurrentSketch</h3>

            <div class="distance-inputs">
                <label>Distance from Left:</label>
                <input type="number" @bind="LeftDistance" placeholder="Enter left distance" /><br />

                <label>Distance from Right:</label>
                <input type="number" @bind="RightDistance" placeholder="Enter right distance" /><br /><br />

                <button class="save-button" @onclick="ApplyDistances">💾 Save</button>
            </div>
        </div>
        @if (showDeleteConfirmation)
        {
            <div class="confirm-box">
                <p>Are you sure you want to delete CT_@CurrentSketch?</p>
                <button @onclick="ConfirmDelete">Yes</button>
                <button @onclick="() => showDeleteConfirmation = false">Cancel</button>
            </div>
        }


        <div class="nav-buttons">
            <button @onclick="GoBack" disabled="@(currentStationIndex == 0)">⬅️ Back</button>
            <button @onclick="GoNext" disabled="@(currentStationIndex == stations.Count - 1)">Next ➡️</button>
        </div>
        @if (stations.Count > 0)
        {
            <div class="continue-section">
                <img src="Images/Continue.gif"
                     @onclick="ContinueToSinkCooktop"
                     style="cursor:pointer; width:150px; height:auto;"
                     alt="Continue" title="Click to continue" />
            </div>

        }

    }
}

@code {
    [Parameter]
    [SupplyParameterFromQuery(Name = "base")]
    public string? baseName { get; set; }

    private bool isLoading = true;
    private List<CountertopStation> stations = new();
    private int currentStationIndex = 0;
    private string CurrentSketch =>
        (stations.Count > 0 && currentStationIndex >= 0 && currentStationIndex < stations.Count)
        ? stations[currentStationIndex].SketchName
        : "";
    private double? LeftDistance { get; set; }
    private double? RightDistance { get; set; }

    private bool showDeleteConfirmation = false;

    void Log(string message)
    {
        string debugPath = @"C:\Users\chouse\Downloads\Kitchenbuilder\Output\countertop_debug.txt";
        string timestamped = $"{DateTime.Now:yyyy-MM-dd HH:mm:ss} - {message}{System.Environment.NewLine}";
        File.AppendAllText(debugPath, timestamped);
    }

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        await Task.Run(() =>
        {
            Log("🟢 OnInitialized started in /countertop-options");

            if (string.IsNullOrWhiteSpace(baseName))
            {
                Log("❌ baseName is null or empty");
                return;
            }

            string jsonPath = Path.Combine(@"C:\Users\chouse\Downloads\Kitchenbuilder\Kitchenbuilder\JSON", $"{baseName}SLD.json");
            string partPath = Path.Combine(@"C:\Users\chouse\Downloads\Kitchenbuilder\Output\temp", $"temp_{baseName}.SLDPRT");

            Log($"📦 baseName = {baseName}");
            Log($"📄 JSON path = {jsonPath}");
            Log($"🧱 Part path = {partPath}");

            if (!File.Exists(jsonPath) || !File.Exists(partPath))
            {
                Log("❌ JSON or SLDPRT file does not exist.");
                return;
            }

            try
            {
                ISldWorks swApp;
                try { swApp = SwSession.GetApp(); }
                catch (Exception ex)
                {
                    Log($"❌ Failed to get SolidWorks app: {ex.Message}");
                    return;
                }

                int errors = 0, warnings = 0;
                var model = swApp.OpenDoc6(partPath,
                    (int)swDocumentTypes_e.swDocPART,
                    (int)swOpenDocOptions_e.swOpenDocOptions_Silent,
                    "", ref errors, ref warnings) as IModelDoc2;

                if (model == null)
                {
                    Log("❌ Failed to open part.");
                    return;
                }

                SwSession.SetActiveModel(model);
                LayoutLauncher.ArrangeWindows(swApp); // <-- ADD THIS LINE HERE


                string jsonText = File.ReadAllText(jsonPath);
                var jsonDoc = JsonDocument.Parse(jsonText);
                foreach (var wallName in new[] { "Wall1", "Wall2", "Wall3", "Wall4" })
                {
                    if (!jsonDoc.RootElement.TryGetProperty(wallName, out JsonElement wall)) continue;
                    if (!wall.TryGetProperty("Bases", out JsonElement bases)) continue;

                    foreach (var baseItem in bases.EnumerateObject())
                    {
                        var baseValue = baseItem.Value;
                        if (!baseValue.TryGetProperty("Visible", out JsonElement vis) || !vis.GetBoolean()) continue;
                        if (!baseValue.TryGetProperty("SketchName", out JsonElement sketchProp)) continue;

                        string sketchName = sketchProp.GetString();
                        if (string.IsNullOrWhiteSpace(sketchName)) continue;

                        string extrudeName = $"Extrude_CT_{sketchName}";
                        Log($"👁️ Attempting to show countertop body: {extrudeName}");
                        Show_Bodies_In_Sld.ShowBody((ModelDoc2)model, extrudeName);
                    }
                }
                // 💾 Save the file after showing countertop bodies
                int saveErrors = 0;
                bool saved = model.Save3((int)swSaveAsOptions_e.swSaveAsOptions_Silent, ref saveErrors, ref saveErrors);
                Log(saved ? "✅ Part file saved successfully after showing bodies." : $"❌ Failed to save part file. Error code: {saveErrors}");


                // ✅ Call only once after the loop:
                AddCountertopFields(jsonPath);

                // ✅ Then extract updated stations
                stations = ExtractCountertopStations(jsonPath);

                stations = ExtractCountertopStations(jsonPath);
                if (stations.Count > 0)
                {
                    EditCurrentSketch();
                }

                Log("✅ Finished showing all countertop bodies.");
            }
            catch (Exception ex)
            {
                Log($"❌ Exception in OnInitialized: {ex.Message}");
            }
        });

        isLoading = false;
    }

    private void GoNext()
    {
        if (currentStationIndex < stations.Count - 1)
        {
            currentStationIndex++;
            EditCurrentSketch();
        }
    }

    private void GoBack()
    {
        if (currentStationIndex > 0)
        {
            currentStationIndex--;
            EditCurrentSketch();
        }
    }

    private void GoTo(int index)
    {
        if (index >= 0 && index < stations.Count)
        {
            currentStationIndex = index;
            EditCurrentSketch();
        }
    }

    private void EditCurrentSketch()
    {
        var model = SwSession.GetActiveModel();
        if (model != null && !string.IsNullOrEmpty(CurrentSketch))
        {
            string sketchName = $"CT_{CurrentSketch}";
            HandleCounterTop.EditSketchByName(model, sketchName, Log);
        }

        // Sync values from station
        var current = stations[currentStationIndex];
        LeftDistance = current.Left;
        RightDistance = current.Right;
    }

    private void ApplyDistances()
    {
        var model = SwSession.GetActiveModel();
        if (model != null && !string.IsNullOrEmpty(CurrentSketch))
        {
            int wallNumber = GetWallNumber(CurrentSketch);
            CountertopDimensionApplier.ApplyDistance(model, CurrentSketch, LeftDistance, RightDistance, wallNumber, Log);
            Log($"✅ Applied distances for {CurrentSketch}: L={LeftDistance}, R={RightDistance}, Wall={wallNumber}");
            HandleCounterTop.UpdateJsonCountertopDistances(baseName, CurrentSketch, LeftDistance, RightDistance, Log);

        }
        else
        {
            Log("❌ Cannot apply distances. Model or Sketch is null.");
        }
    }
    private int GetWallNumber(string sketchName)
    {
        // Example: "1_2" → wall 1
        if (!string.IsNullOrWhiteSpace(sketchName) && sketchName.Contains("_"))
        {
            var parts = sketchName.Split('_');
            if (int.TryParse(parts[0], out int wallNum))
                return wallNum;
        }
        return 0; // default fallback
    }
    private void DeleteCountertop()
    {
        Log($"🗑️ Delete icon clicked for CT_{CurrentSketch}");
        showDeleteConfirmation = true;
    }

    private void ConfirmDelete()
    {
        showDeleteConfirmation = false;

        Log($"🗑️ Confirmed deletion for CT_{CurrentSketch}");

        // 1. Update JSON
        UpdateJsonCountertopDistances(baseName, CurrentSketch, null, null, Log, true);

        // 2. Delete from SLDPRT
        var model = SwSession.GetActiveModel();
        if (model != null)
        {
            string sketchName = $"CT_{CurrentSketch}";
            HandleCounterTop.DeleteSketchByName(model, sketchName, Log);
            Log($"🧹 Deleted sketch {sketchName}");
        }

        // 3. Remove the deleted station from the list
        stations.RemoveAt(currentStationIndex);
        Log($"❌ Removed station {CurrentSketch} from list");

        // 4. Reset current index (go to first or previous)
        if (stations.Count == 0)
        {
            Log("⚠️ No stations left after deletion.");
            return; // optionally show a message in UI
        }

        currentStationIndex = Math.Min(currentStationIndex, stations.Count - 1);
        EditCurrentSketch(); // sync the new active station

        // 5. Clear distances (will be replaced by EditCurrentSketch)
        LeftDistance = null;
        RightDistance = null;
    }



    void ContinueToSinkCooktop()
    {
        if (!string.IsNullOrWhiteSpace(baseName))
        {
            string option = baseName.Replace("SLD", ""); // Converts Option3SLD → Option3
            NavManager.NavigateTo($"/sink-cooktop-options?option={option}");
        }
    }

}
